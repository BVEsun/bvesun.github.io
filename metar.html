<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METAR and TAF for VHHH, VMMC, ZGSZ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 40px;
        }
        
        /* SOLUTION FOR ISSUE #3: More space for chart */
        .chart-section {
            margin-bottom: 100px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 10px;
        }
        
        .chart-container {
            height: 600px;
            position: relative;
        }
        
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 8px;
        }
        
        .data-section {
            display: flex;
            justify-content: space-between;
            gap: 25px;
            margin-top: 0;
        }
        
        .column {
            flex: 1;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        pre {
            min-height: 120px;
            background-color: white;
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>METAR and TAF for VHHH, VMMC, ZGSZ</h1>
    
    <div class="chart-section">
        <h2 style="text-align: center; margin-bottom: 25px;">METAR Data Chart</h2>
        
        <div class="controls">
            <label>Select Elements (up to 2):</label>
            <select id="element1" onchange="updateChart()">
                <option value="windDir" selected>Wind Direction (°)</option>
                <option value="windSpeed">Wind Speed (kt)</option>
                <option value="qnh">QNH (hPa)</option>
                <option value="temp">Temperature (°C)</option>
                <option value="visibility">Visibility (m)</option>
            </select>
            <select id="element2" onchange="updateChart()">
                <option value="">Select Element 2</option>
                <option value="windDir">Wind Direction (°)</option>
                <option value="windSpeed">Wind Speed (kt)</option>
                <option value="qnh">QNH (hPa)</option>
                <option value="temp">Temperature (°C)</option>
                <option value="visibility">Visibility (m)</option>
            </select>
            <br><br>
            <label>Select Stations:</label>
            <input type="checkbox" id="vhhh-check" checked onchange="updateChart()"> VHHH
            <input type="checkbox" id="vmmc-check" checked onchange="updateChart()"> VMMC
            <input type="checkbox" id="zgsz-check" checked onchange="updateChart()"> ZGSZ
            <button onclick="fetchWeatherData()">Refresh Data</button>
        </div>
        
        <div class="chart-container">
            <canvas id="metarChart"></canvas>
        </div>
    </div>
    
    <div class="data-section">
        <div class="column">
            <h2>VHHH (Hong Kong)</h2>
            <h3>METAR</h3>
            <pre id="metar-vhhh">Loading METAR data...</pre>
            <h3>TAF</h3>
            <pre id="taf-vhhh">Loading TAF data...</pre>
        </div>
        <div class="column">
            <h2>VMMC (Macau)</h2>
            <h3>METAR</h3>
            <pre id="metar-vmmc">Loading METAR data...</pre>
            <h3>TAF</h3>
            <pre id="taf-vmmc">Loading TAF data...</pre>
        </div>
        <div class="column">
            <h2>ZGSZ (Shenzhen)</h2>
            <h3>METAR</h3>
            <pre id="metar-zgsz">Loading METAR data...</pre>
            <h3>TAF</h3>
            <pre id="taf-zgsz">Loading TAF data...</pre>
        </div>
    </div>

    <script>
        let chart = null;
        let metarData = {
            VHHH: [],
            VMMC: [],
            ZGSZ: []
        };

        // SOLUTION FOR ISSUE #1: Properly configure Chart.js to prevent unused y-axis
        function createChartConfig(datasets, labels) {
            // First, determine which y-axes are actually needed
            const usedAxes = new Set();
            datasets.forEach(ds => {
                if (ds.yAxisID) {
                    usedAxes.add(ds.yAxisID);
                }
            });
            
            // Define axis configurations
            const axisConfigs = {
                windDir: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    min: 0,
                    max: 360,
                    title: {
                        display: true,
                        text: 'Wind Direction (°)'
                    }
                },
                windSpeed: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Wind Speed (kt)'
                    }
                },
                qnh: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    min: 900,
                    max: 1100,
                    title: {
                        display: true,
                        text: 'QNH (hPa)'
                    }
                },
                temp: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    min: -10,
                    max: 50,
                    title: {
                        display: true,
                        text: 'Temperature (°C)'
                    }
                },
                visibility: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    min: 0,
                    max: 10000,
                    title: {
                        display: true,
                        text: 'Visibility (m)'
                    }
                }
            };
            
            // Build scales configuration
            const scales = {
                x: {
                    title: {
                        display: true,
                        text: 'Time (DDHHMM)'
                    }
                }
            };
            
            // Only add y axes if we have datasets that use them
            if (usedAxes.size > 0) {
                scales.y = {};
                
                // Position axes properly (first on left, second on right)
                let leftAxisAdded = false;
                let rightAxisAdded = false;
                
                usedAxes.forEach(axisId => {
                    if (axisConfigs[axisId]) {
                        if (!leftAxisAdded) {
                            scales.y[axisId] = {
                                ...axisConfigs[axisId],
                                position: 'left'
                            };
                            leftAxisAdded = true;
                        } else {
                            scales.y[axisId] = {
                                ...axisConfigs[axisId],
                                position: 'right'
                            };
                            rightAxisAdded = true;
                        }
                    }
                });
            }
            
            return {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: scales,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            };
        }

        // SOLUTION FOR ISSUE #2: Properly parse ZGSZ data with MPS units
        function parseMetar(line) {
            // Extract station ID
            const stationMatch = line.match(/(VHHH|VMMC|ZGSZ)/);
            if (!stationMatch) return null;
            const station = stationMatch[1];
            
            // Extract time (6 digits followed by Z)
            const timeMatch = line.match(/\b(\d{6})Z\b/);
            if (!timeMatch) return null;
            const time = timeMatch[1];
            
            // Wind data - handle both KT and MPS units
            let windDir = null;
            let windSpeed = null;
            let windGust = null;
            
            // First try KT format (e.g., 32015KT)
            let windMatch = line.match(/\b(\d{3}|VRB)(\d{2})(?:G(\d{2}))?KT\b/);
            if (windMatch) {
                windDir = windMatch[1] === 'VRB' ? null : parseInt(windMatch[1]);
                windSpeed = parseInt(windMatch[2]);
                windGust = windMatch[3] ? parseInt(windMatch[3]) : null;
            } else {
                // Try MPS format (e.g., 36005MPS) - SOLUTION FOR ZGSZ
                windMatch = line.match(/\b(\d{3}|VRB)(\d{2})(?:G(\d{2}))?MPS\b/);
                if (windMatch) {
                    windDir = windMatch[1] === 'VRB' ? null : parseInt(windMatch[1]);
                    // Convert MPS to KT (1 m/s = 1.94384 knots)
                    windSpeed = Math.round(parseInt(windMatch[2]) * 1.94384);
                    windGust = windMatch[3] ? Math.round(parseInt(windMatch[3]) * 1.94384) : null;
                }
            }
            
            // QNH (e.g., Q1007)
            let qnh = null;
            const qnhMatch = line.match(/\bQ(\d{4})\b/);
            if (qnhMatch) {
                qnh = parseInt(qnhMatch[1]);
            }
            
            // Temperature (e.g., 30/23)
            let temp = null;
            const tempMatch = line.match(/\b(M?\d{2})\/(M?\d{2})\b/);
            if (tempMatch) {
                temp = tempMatch[1].startsWith('M') ? 
                       -parseInt(tempMatch[1].slice(1)) : 
                       parseInt(tempMatch[1]);
            }
            
            // Visibility (4 digits)
            let visibility = null;
            const visMatch = line.match(/\b(\d{4})\b/);
            if (visMatch && !visMatch[0].startsWith('Q') && !visMatch[0].includes('Z')) {
                visibility = parseInt(visMatch[1]);
            }
            
            return {
                station: station,
                time: time,
                windDir: windDir,
                windSpeed: windSpeed,
                windGust: windGust,
                qnh: qnh,
                temp: temp,
                visibility: visibility
            };
        }

        async function fetchWeatherData() {
            try {
                // Clear existing data
                metarData = { VHHH: [], VMMC: [], ZGSZ: [] };
                
                const response = await fetch('https://aviationweather.gov/api/data/metar?ids=VHHH,VMMC,ZGSZ&taf=true&hours=12&format=raw');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                
                const data = await response.text();
                const lines = data.split('\n').filter(line => line.trim() !== '');
                
                // Process all lines
                for (const line of lines) {
                    if (line.startsWith('METAR') || line.startsWith('SPECI')) {
                        const parsed = parseMetar(line);
                        if (parsed && metarData[parsed.station]) {
                            metarData[parsed.station].push(parsed);
                        }
                    }
                }
                
                // Update UI with raw data
                for (const station of ['VHHH', 'VMMC', 'ZGSZ']) {
                    const metarText = lines
                        .filter(line => line.includes(station) && (line.startsWith('METAR') || line.startsWith('SPECI')))
                        .join('\n') || `No METAR data for ${station}`;
                        
                    const tafText = lines
                        .filter(line => line.includes(station) && line.startsWith('TAF'))
                        .join('\n') || `No TAF data for ${station}`;
                        
                    document.getElementById(`metar-${station.toLowerCase()}`).textContent = metarText;
                    document.getElementById(`taf-${station.toLowerCase()}`).textContent = tafText;
                }
                
                // Debug ZGSZ data
                console.log("ZGSZ data count:", metarData.ZGSZ.length);
                if (metarData.ZGSZ.length > 0) {
                    console.log("Sample ZGSZ data (after parsing):", metarData.ZGSZ[0]);
                }
                
                updateChart();
            } catch (error) {
                console.error('Error:', error);
                for (const station of ['vhhh', 'vmmc', 'zgsz']) {
                    document.getElementById(`metar-${station}`).textContent = `Error: ${error.message}`;
                    document.getElementById(`taf-${station}`).textContent = `Error: ${error.message}`;
                }
            }
        }

        function updateChart() {
            const element1 = document.getElementById('element1').value;
            const element2 = document.getElementById('element2').value;
            const stations = [];
            if (document.getElementById('vhhh-check').checked) stations.push('VHHH');
            if (document.getElementById('vmmc-check').checked) stations.push('VMMC');
            if (document.getElementById('zgsz-check').checked) stations.push('ZGSZ');

            const datasets = [];
            const labelsSet = new Set();
            const colors = {
                VHHH: 'rgba(54, 162, 235, 1)',
                VMMC: 'rgba(75, 192, 192, 1)',
                ZGSZ: 'rgba(255, 99, 132, 1)'
            };

            // SOLUTION FOR ISSUE #2: Ensure ZGSZ data is properly handled
            stations.forEach(station => {
                if (!metarData[station] || metarData[station].length === 0) {
                    return;
                }
                
                // Sort data by time
                const sortedData = [...metarData[station]].sort((a, b) => 
                    a.time.localeCompare(b.time)
                );
                
                // Filter valid data points
                const validData = sortedData.filter(d => 
                    d && d.time && (
                        (element1 && d[element1] !== null && d[element1] !== undefined) ||
                        (element2 && d[element2] !== null && d[element2] !== undefined)
                    )
                );
                
                if (validData.length === 0) {
                    return;
                }
                
                // Collect time labels
                validData.forEach(d => labelsSet.add(d.time));
                
                // Create dataset for element1
                if (element1) {
                    datasets.push({
                        label: `${station} ${element1}`,
                         validData.map(d => d[element1]),
                        borderColor: colors[station],
                        backgroundColor: colors[station].replace('1)', '0.2)'),
                        fill: false,
                        yAxisID: element1,
                        pointRadius: 4,
                        borderWidth: 2
                    });
                }
                
                // Create dataset for element2
                if (element2 && element2 !== element1) {
                    datasets.push({
                        label: `${station} ${element2}`,
                         validData.map(d => d[element2]),
                        borderColor: colors[station],
                        backgroundColor: colors[station].replace('1)', '0.2)'),
                        borderDash: [5, 5],
                        fill: false,
                        yAxisID: element2,
                        pointRadius: 4,
                        borderWidth: 2
                    });
                }
            });

            // Destroy previous chart
            if (chart) {
                chart.destroy();
            }

            const labels = Array.from(labelsSet).sort();
            
            // SOLUTION FOR ISSUE #1: Use our precise chart config function
            if (datasets.length > 0 && labels.length > 0) {
                const config = createChartConfig(datasets, labels);
                chart = new Chart(document.getElementById('metarChart'), config);
            } else {
                const canvas = document.getElementById('metarChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No data to display - check your selections', canvas.width/2, canvas.height/2);
            }
        }

        // Initialize
        window.addEventListener('load', fetchWeatherData);
    </script>
</body>
</html>
